name: Build ToDo Project (GitOps)

on:
  push:
    branches:
      - main
    tags:
      - '*'
    paths:
      - 'ToDo-App/**'
      - 'ToDo-Backend/**'
      - 'Broadcaster/**'
      - '.github/workflows/project.yaml'

env:
  PROJECT_ID: ${{ secrets.GKE_PROJECT }}
  REGISTRY: gcr.io

permissions:
  contents: write

jobs:
  build-publish:
    name: Build, Push, Release
    runs-on: ubuntu-latest
    environment: DWK

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "ENVIRONMENT=production" >> $GITHUB_OUTPUT
            echo "OVERLAY=production" >> $GITHUB_OUTPUT
          else
            echo "ENVIRONMENT=staging" >> $GITHUB_OUTPUT
            echo "OVERLAY=staging" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GKE_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: gcloud --quiet auth configure-docker

      # Build and push ToDo-App
      - name: Build and Push ToDo-App
        run: |
          docker build -t $REGISTRY/$PROJECT_ID/todo-app:${{ github.sha }} ./ToDo-App
          docker push $REGISTRY/$PROJECT_ID/todo-app:${{ github.sha }}

      # Build and push ToDo-Backend
      - name: Build and Push ToDo-Backend
        run: |
          docker build -t $REGISTRY/$PROJECT_ID/todo-backend:${{ github.sha }} ./ToDo-Backend
          docker push $REGISTRY/$PROJECT_ID/todo-backend:${{ github.sha }}

      # Build and push ToDo-CronJob
      - name: Build and Push ToDo-CronJob
        run: |
          docker build -t $REGISTRY/$PROJECT_ID/todo-cronjob:${{ github.sha }} ./ToDo-Backend/cronjob
          docker push $REGISTRY/$PROJECT_ID/todo-cronjob:${{ github.sha }}

      # Build and push ToDo-Backup (only for production)
      - name: Build and Push ToDo-Backup
        if: steps.env.outputs.ENVIRONMENT == 'production'
        run: |
          docker build -t $REGISTRY/$PROJECT_ID/todo-backup:${{ github.sha }} ./ToDo-Backend/backup
          docker push $REGISTRY/$PROJECT_ID/todo-backup:${{ github.sha }}

      # Build and push Broadcaster
      - name: Build and Push Broadcaster
        run: |
          docker build -t $REGISTRY/$PROJECT_ID/broadcaster:${{ github.sha }} ./Broadcaster
          docker push $REGISTRY/$PROJECT_ID/broadcaster:${{ github.sha }}

      # Set up Kustomize
      - name: Set up Kustomize
        uses: imranismail/setup-kustomize@v2

      # Update ToDo-Backend overlay with new image tags
      - name: Update ToDo-Backend images
        run: |
          cd ToDo-Backend/manifests/overlays/${{ steps.env.outputs.OVERLAY }}
          kustomize edit set image PROJECT/TODO_BACKEND=$REGISTRY/$PROJECT_ID/todo-backend:${{ github.sha }}
          kustomize edit set image PROJECT/TODO_CRONJOB=$REGISTRY/$PROJECT_ID/todo-cronjob:${{ github.sha }}

      # Update production backup image
      - name: Update ToDo-Backup image (production only)
        if: steps.env.outputs.ENVIRONMENT == 'production'
        run: |
          cd ToDo-Backend/manifests/overlays/production
          kustomize edit set image PROJECT/TODO_BACKUP=$REGISTRY/$PROJECT_ID/todo-backup:${{ github.sha }}

      # Update ToDo-App overlay with new image tag
      - name: Update ToDo-App images
        run: |
          cd ToDo-App/manifests/overlays/${{ steps.env.outputs.OVERLAY }}
          kustomize edit set image PROJECT/TODO_APP=$REGISTRY/$PROJECT_ID/todo-app:${{ github.sha }}

      # Update Broadcaster overlay with new image tag
      - name: Update Broadcaster images
        run: |
          cd Broadcaster/manifests/overlays/${{ steps.env.outputs.OVERLAY }}
          kustomize edit set image PROJECT/BROADCASTER=$REGISTRY/$PROJECT_ID/broadcaster:${{ github.sha }}

      # Commit the updated kustomization files
      - name: Commit kustomization changes
        uses: EndBug/add-and-commit@v9
        with:
          add: |
            ToDo-Backend/manifests/overlays/${{ steps.env.outputs.OVERLAY }}/kustomization.yaml
            ToDo-App/manifests/overlays/${{ steps.env.outputs.OVERLAY }}/kustomization.yaml
            Broadcaster/manifests/overlays/${{ steps.env.outputs.OVERLAY }}/kustomization.yaml
          message: 'ci: Update ${{ steps.env.outputs.ENVIRONMENT }} images to ${{ github.sha }}'
          default_author: github_actions
